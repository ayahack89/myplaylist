<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vibelist - Work with a vibe</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="shortcut icon" href="img/tab-icon.jpg" type="image/jpeg">
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

</head>

<body>
  <div class="wrap">
    <header>
      <div class="header-content" style="align-items:center; gap:18px;">
        <!-- Logo: subtle gradient text + small tagline -->
        <div class="logo" style="display:flex; align-items:center; gap:12px;">
          <i class="ri-music-ai-line" style="font-size:34px; color:var(--accent);"></i>
          <div style="display:flex; flex-direction:column; line-height:1;">
            <span style="font-weight:700; font-size:1.6rem;
                     background: linear-gradient(90deg,#8aa2ff,#6ad1c8);
                     -webkit-background-clip: text; color: transparent;">
              Vibelist
            </span>
            <small style="font-size:12px; color:var(--muted); margin-top:2px;">Work with a vibe</small>
          </div>
        </div>

        <!-- Center controls: search (keeps same id for JS) -->
        <div class="controls" style="flex:1; display:flex; justify-content:center;">
          <div class="search" title="Search songs or artists (iTunes)" style="display:flex; align-items:center; gap:10px; background: rgba(255,255,255,0.02);
                  border:1px solid var(--border-color); padding:8px 14px; border-radius:999px; width:100%;
                  max-width:520px;">
            <i class="ri-search-line" style="color:var(--muted); font-size:18px;"></i>
            <input id="searchBox"
              style='background:transparent; border:0; outline:0; color:inherit; width:100%;
                      font-family: "Libertinus Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;'
              placeholder="Search songs, artists (press Enter)" />
            <!-- subtle clear button (no behavior required; you can hook JS to it if needed) -->
            <button type="button" class="clear-search" aria-label="Clear search" style="border:0; background:transparent; width:36px; height:36px; border-radius:8px; display:flex;
                       align-items:center; justify-content:center; color:var(--muted); cursor:pointer;">
              <i class="ri-close-line" style="font-size:18px;"></i>
            </button>
          </div>
        </div>

        <!-- Right navigation icons: pill buttons for modern/clean look -->
        <nav class="navv" style="display:flex; align-items:center;">
          <ul style="display:flex; gap:10px; margin:0; padding:0; align-items:center; list-style:none;">
            <li>
              <div class="tooltip">
                <a href="#" id="homeBtn" style="display:inline-flex; align-items:center; justify-content:center;
                                             width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02);
                                             border:1px solid transparent; color:var(--muted);">
                  <i class="ri-home-5-line" style="font-size:18px;"></i>
                </a>
                <div class="tooltipText">Home</div>
              </div>
            </li>

            <li>
              <div class="tooltip">
                <a href="https://open.spotify.com" target="_blank"
                  style="display:inline-flex; align-items:center; justify-content:center;
                                                                       width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02);
                                                                       border:1px solid transparent; color:var(--muted);">
                  <i class="ri-spotify-line" style="font-size:18px;"></i>
                </a>
                <div class="tooltipText">Spotify</div>
              </div>
            </li>

            <li>
              <div class="tooltip">
                <a href="https://x.com/ayanabha08" target="_blank"
                  style="display:inline-flex; align-items:center; justify-content:center;
                                                                      width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02);
                                                                      border:1px solid transparent; color:var(--muted);">
                  <i class="ri-twitter-x-fill" style="font-size:18px;"></i>
                </a>
                <div class="tooltipText">X (Formaly twitter)</div>
              </div>
            </li>

            <li>
              <div class="tooltip">
                <a href="https://www.github.com/ayahack89/" target="_blank"
                  style="display:inline-flex; align-items:center; justify-content:center;
                                                                      width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02);
                                                                      border:1px solid transparent; color:var(--muted);">
                  <i class="ri-github-line" style="font-size:18px;"></i>
                </a>
                <div class="tooltipText">Github repo</div>
              </div>
            </li>

            <li>
              <div class="tooltip">
                <a href="about.html" style="display:inline-flex; align-items:center; justify-content:center;
                                                        width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02);
                                                        border:1px solid transparent; color:var(--muted);">
                  <i class="ri-attachment-line" style="font-size:18px;"></i>
                </a>
                <div class="tooltipText">About</div>
              </div>
            </li>

            <!-- small user avatar (keeps header balanced and modern) -->
            <li>
              <div style="display:inline-flex; align-items:center; gap:8px; margin-left:6px;">
                <div class="avatar" title="You"
                  style="width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center;
                        font-size:13px; font-weight:600; background:linear-gradient(135deg,#5ea4ff,#8ee0c1); color:#042033;">
                  A
                </div>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </header>


    <main>
      <div class="grid" id="playlists">
      </div>
      <div
        style="margin-top:24px; text-align:center; padding: 20px; background: var(--card); border-radius: 12px; border: 1px solid var(--border-color);">
        <h2 style="margin-top:0;">What you need to know</h2>
        <p
          style="font-size:14px; color: var(--muted); max-width: 650px; margin: 1.5rem auto 0; line-height: 1.6; text-align: center;">
          <strong>Note:</strong> Vibelist is a personal, frontend-only project built for fun and inspiration.
          It uses public music APIs to fetch song metadata and provide short preview clips (≈30 seconds).
          For full-length streaming, please use licensed providers such as <a href="https://spotify.com" target="_blank"
            style="color: var(--primary); text-decoration: none;">Spotify</a>, Apple Music, or others.
          Think of this as a <em>Spotify-inspired demo</em> — a lightweight way to explore and enjoy vibes, not affiliated with
          commercial streaming service. 
        </p>

      </div>
    </main>
  </div>

  <footer id="player-footer" style="display:none">
    <div class="now-playing-bar" id="nowPlaying">
      <div class="track-info">
        <img id="nowCover" alt="album cover" />
        <div>
          <div id="nowTitle"></div>
          <div id="nowArtist"></div>
        </div>
      </div>
      <audio id="player" controls></audio>
    </div>
  </footer>

  <script>
    // --- DATA ---
    const myPlaylist = [
      { id: 'local-2', title: "METAMORPHOSIS", artist: "INTERWORLD · IVAN BELOZEROV", cover: "https://i.pinimg.com/564x/d8/d6/fa/d8d6fa9287f459cbf70bee4f247f663b.jpg", preview: "music/Metamorphosis(PagalWorld.Social).mp3", source: "local" },
      { id: 'local-3', title: "RAPTURE (PHONK)", artist: "INTERWORLD", cover: "https://i.pinimg.com/564x/2a/7f/df/2a7fdf566753548414ed6c523fd3a5a9.jpg", preview: "music/RAPTURE-(PHONK)(PagalWorld.Social).mp3", source: "local" },
      { id: 'local-4', title: "The Lost Soul Down", artist: "NBSPLV", cover: "https://i.pinimg.com/564x/02/89/8c/02898c1ac7c0b5ad97af001292da7322.jpg", preview: "music/zamona-net-nbsplv-the-lost-soul-down-slowed-reverb.mp3", source: "local" },
      { id: 'local-5', title: "Softcore", artist: "The Neighbourhood", cover: "https://i.pinimg.com/564x/0b/e6/9d/0be69d1804e58f5b13f4de6092ebbfe9.jpg", preview: "music/zamona-net-the-neighbourhood-softcore.mp3", source: "local" },
      { id: 'local-6', title: "Resonance", artist: "HOME", cover: "https://i.pinimg.com/564x/22/c4/d1/22c4d18fea768c0c4948076c7fe61554.jpg", preview: "music/HOME - Resonance.mp3", source: "local" },
      { id: 'local-7', title: "I Was Never There", artist: "The Weeknd feat. Gesaffelstein", cover: "https://i.pinimg.com/564x/a0/d6/5a/a0d65a1c8af224e6c34a118fabd194cc.jpg", preview: "music/I-Was-Never-There(PaglaSongs).mp3", source: "local" },
      { id: 'local-8', title: "Starboy", artist: "The Weeknd ft. Daft Punk", cover: "https://i.pinimg.com/564x/17/e9/20/17e9204783b721db7e1362727c6a18f3.jpg", preview: "music/The20WeekndDaft20Punk20-20Starboy20.mp3", source: "local" },
      { id: 'local-9', title: "Under The Influence", artist: "Chris Brown", cover: "https://i.pinimg.com/564x/54/73/ff/5473ff8c30504889725358ca1ef573bd.jpg", preview: "music/Under-The-Influence(PagalWorld).mp3", source: "local" },
      { id: 'local-10', title: "House of Memories", artist: "Panic! At The Disco", cover: "https://i.pinimg.com/564x/00/b9/f0/00b9f0066f72baf4f4203cebc0c63fe2.jpg", preview: "music/House-Of-Memories-(Slowed-Reverb)-Lofi-Mix(PagalWorld).mp3", source: "local" },
      { id: 'local-11', title: "Mary On A Cross", artist: "Ghost", cover: "https://i.pinimg.com/564x/8d/d5/6c/8dd56c4e8049346d2de78c7f645f4f6d.jpg", preview: "music/Ghost---Mary-On-A-Cross(PagalWorld).mp3", source: "local" },
      { id: 'local-12', title: "Everybody Wants To Rule The World", artist: "Tears For Fears", cover: "https://i.pinimg.com/564x/9c/ad/2b/9cad2b5172f3be50fc69892174d35a70.jpg", preview: "music/Tears_for_Fears_-_Everybody_Wants_To_Rule_The_World.mp3", source: "local" },
      { id: 'local-13', title: "One Kiss", artist: "Calvin Harris & Dua Lipa", cover: "https://i.pinimg.com/564x/62/af/43/62af4388b6f44f4aa625fdf2f3be5c1c.jpg", preview: "music/One-Kiss(PaglaSongs).mp3", source: "local" }
    ];

    const seeds = {
      "Pop Favorites": [
        { "artist": "Taylor Swift", "songs": ["Anti-Hero", "Shake It Off", "Blank Space", "Love Story", "You Belong With Me", "Willow"] },
        { "artist": "Dua Lipa", "songs": ["Levitating", "Don't Start Now", "New Rules", "Physical", "Break My Heart", "One Kiss"] },
        { "artist": "Ed Sheeran", "songs": ["Shape of You", "Perfect", "Thinking Out Loud", "Bad Habits", "Castle on the Hill", "Photograph"] },
        { "artist": "Adele", "songs": ["Hello", "Someone Like You", "Rolling in the Deep", "Set Fire to the Rain", "Easy on Me", "When We Were Young"] },
        { "artist": "Harry Styles", "songs": ["As It Was", "Watermelon Sugar", "Sign of the Times", "Adore You", "Falling", "Golden"] },
        { "artist": "Ariana Grande", "songs": ["7 rings", "Thank U, Next", "God Is a Woman", "No Tears Left to Cry", "Positions", "Side to Side"] },
        { "artist": "Beyoncé", "songs": ["Single Ladies (Put a Ring on It)", "Halo", "Crazy In Love", "Formation", "Drunk in Love", "If I Were a Boy"] },
        { "artist": "Billie Eilish", "songs": ["Bad Guy", "Everything I Wanted", "Therefore I Am", "Ocean Eyes", "Happier Than Ever", "When the Party's Over"] },
        { "artist": "Justin Bieber", "songs": ["Sorry", "Love Yourself", "Peaches", "Baby", "What Do You Mean?", "Intentions"] },
        { "artist": "Bruno Mars", "songs": ["Uptown Funk (w/ Mark Ronson)", "Just the Way You Are", "24K Magic", "That's What I Like", "Grenade", "Locked Out of Heaven"] },
        { "artist": "Katy Perry", "songs": ["Firework", "Roar", "Dark Horse", "Teenage Dream", "California Gurls", "Last Friday Night"] },
        { "artist": "Maroon 5", "songs": ["Sugar", "Memories", "Moves Like Jagger", "She Will Be Loved", "Payphone", "Girls Like You"] }
      ],

      "Chill / Lofi": [
        { "artist": "HOME", "songs": ["Resonance", "Odyssey (short)", "Blank (if available)", "Revisit", "Late Night Drives"] },
        { "artist": "INTERWORLD", "songs": ["METAMORPHOSIS", "RAPTURE", "other ambient phonk cuts"] },
        { "artist": "Nujabes", "songs": ["Feather", "Luv(sic) Part 3", "Aruarian Dance", "Reflection Eternal", "Battlecry", "Counting Stars"] },
        { "artist": "Khruangbin", "songs": ["Maria También", "So We Won't Forget", "Time (You and I)", "White Gloves", "People Everywhere (Still Alive)"] },
        { "artist": "Still Woozy", "songs": ["Goodie Bag", "Cocoa", "Habit", "Window", "Karaoke", "Lucy"] },
        { "artist": "Mac DeMarco", "songs": ["Chamber of Reflection", "My Kind of Woman", "Salad Days", "For the First Time", "Ode to Viceroy", "Cooking Up Something Good"] },
        { "artist": "Bon Iver", "songs": ["Skinny Love", "Holocene", "33 'God'", "Perth", "Blood Bank", "re: Stacks"] },
        { "artist": "Washed Out", "songs": ["Feel It All Around", "Amor Fati", "It All Feels Right", "Eyes Be Closed", "New Theory", "Soft"] },
        { "artist": "Tycho", "songs": ["A Walk", "Awake", "Horizon", "Division", "Dive", "Montana"] },
        { "artist": "Joji", "songs": ["Slow Dancing in the Dark", "Glimpse of Us", "Sanctuary", "YEAH RIGHT", "Will He", "Ew"] },
        { "artist": "Cigarettes After Sex", "songs": ["Nothing's Gonna Hurt You Baby", "Apocalypse", "K.", "Each Time You Fall In Love", "Sweet", "Young & Dumb"] },
        { "artist": "M83", "songs": ["Midnight City", "Wait", "Outro", "Reunion", "Steve McQueen", "Kim & Jessie"] }
      ],

      "Rock & Alternative": [
        { "artist": "The Neighbourhood", "songs": ["Sweater Weather", "Daddy Issues", "Afraid", "R.I.P. 2 My Youth", "Stargazing", "The Beach"] },
        { "artist": "Arctic Monkeys", "songs": ["Do I Wanna Know?", "I Bet You Look Good on the Dancefloor", "R U Mine?", "505", "Why'd You Only Call Me When You're High?", "Fluorescent Adolescent"] },
        { "artist": "Tame Impala", "songs": ["The Less I Know The Better", "Let It Happen", "Elephant", "Feels Like We Only Go Backwards", "Borderline", "Eventually"] },
        { "artist": "The Killers", "songs": ["Mr. Brightside", "Somebody Told Me", "When You Were Young", "Human", "Smile Like You Mean It", "All These Things That I've Done"] },
        { "artist": "Ghost", "songs": ["Square Hammer", "Mary On A Cross", "Cirice", "Rats", "He Is", "Dance Macabre"] },
        { "artist": "Radiohead", "songs": ["Creep", "Karma Police", "Paranoid Android", "No Surprises", "High and Dry", "Everything In Its Right Place"] },
        { "artist": "Foo Fighters", "songs": ["Everlong", "The Pretender", "Best of You", "Learn to Fly", "My Hero", "Times Like These"] },
        { "artist": "Red Hot Chili Peppers", "songs": ["Californication", "Under the Bridge", "Snow (Hey Oh)", "Scar Tissue", "Give It Away", "By the Way"] },
        { "artist": "Muse", "songs": ["Uprising", "Starlight", "Time Is Running Out", "Madness", "Knights of Cydonia", "Plug In Baby"] },
        { "artist": "Imagine Dragons", "songs": ["Radioactive", "Believer", "Thunder", "Demons", "Bad Liar", "It's Time"] },
        { "artist": "Pearl Jam", "songs": ["Alive", "Even Flow", "Jeremy", "Black", "Better Man", "Daughter"] },
        { "artist": "Fleetwood Mac", "songs": ["Dreams", "Go Your Own Way", "The Chain", "Landslide", "Rhiannon", "Everywhere"] }
      ],

      "R&B / Modern": [
        { "artist": "The Weeknd", "songs": ["Blinding Lights", "Save Your Tears", "I Was Never There", "Can't Feel My Face", "The Hills", "In the Night"] },
        { "artist": "SZA", "songs": ["Kill Bill", "Good Days", "Love Galore", "The Weekend", "Broken Clocks", "Garden (Say It Like Dat)"] },
        { "artist": "Frank Ocean", "songs": ["Thinkin Bout You", "Pyramids", "Nikes", "Ivy", "Swim Good", "Pink + White"] },
        { "artist": "Doja Cat", "songs": ["Say So", "Kiss Me More", "Woman", "Need to Know", "Streets", "Juicy"] },
        { "artist": "Brent Faiyaz", "songs": ["Clouded", "Dead Man Walking", "Gravity (feat. Tyler, The Creator)", "Trust", "Rehab (Winter in Paris)", "Make Luv"] },
        { "artist": "Drake", "songs": ["God's Plan", "Hotline Bling", "One Dance", "In My Feelings", "Hold On, We're Going Home", "Passionfruit"] },
        { "artist": "Alicia Keys", "songs": ["Fallin'", "If I Ain't Got You", "No One", "Girl on Fire", "Empire State of Mind (Part II)", "Un-Thinkable"] },
        { "artist": "Miguel", "songs": ["Adorn", "Sure Thing", "Coffee", "Sky Walker", "Do You...", "How Many"] },
        { "artist": "H.E.R.", "songs": ["Focus", "Best Part (w/ Daniel Caesar)", "Hard Place", "Slide (w/ YG)", "Damage", "Comfortable"] },
        { "artist": "Jhené Aiko", "songs": ["The Worst", "Spotless Mind", "While We're Young", "Sailing Not Selling", "Triggered (freestyle)", "P*$$Y Fairy (OTW)"] },
        { "artist": "Daniel Caesar", "songs": ["Get You", "Best Part (w/ H.E.R.)", "Japanese Denim", "Hold Me Down", "We Find Love", "Blessed"] },
        { "artist": "Bruno Mars", "songs": ["That's What I Like", "Versace on the Floor", "When I Was Your Man", "24K Magic", "Locked Out of Heaven", "Just the Way You Are"] }
      ]
    };

    // --- STATE ---
    let currentPlaying = { audio: null, button: null, trackId: null };
    let dragSrcEl = null;

    // --- DOM ELEMENTS ---
    const playlistsEl = document.getElementById('playlists');
    const player = document.getElementById('player');
    const playerFooter = document.getElementById('player-footer');
    const nowCover = document.getElementById('nowCover');
    const nowTitle = document.getElementById('nowTitle');
    const nowArtist = document.getElementById('nowArtist');
    const searchBox = document.getElementById('searchBox');
    const homeBtn = document.getElementById('homeBtn');

    // --- HELPERS ---
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // --- API ---
    async function fetchItunesFor(term, limit = 25) {
      const url = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=song&limit=${limit}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('iTunes fetch failed');
        const j = await res.json();
        return j.results.map(r => ({
          id: r.trackId,
          title: r.trackName || r.collectionName,
          artist: r.artistName,
          cover: r.artworkUrl100?.replace('100x100', '400x400') || r.artworkUrl60,
          preview: r.previewUrl,
          source: 'itunes',
        }));
      } catch (err) {
        console.warn('iTunes fetch error', err);
        return [];
      }
    }

    // --- UI: create a track element (centralized so we can attach events once) ---
    function createTrackElement(t, options = {}) {
      // t: object with id, title, artist, cover, preview, source
      const tr = document.createElement('div');
      tr.className = 'track';
      tr.dataset.trackId = t.id;
      tr.dataset.previewUrl = t.preview || '';
      tr.dataset.cover = t.cover || '';
      tr.dataset.title = t.title || 'Unknown Title';
      tr.dataset.artist = t.artist || 'Unknown Artist';
      if (options.playlistName) tr.closestPlaylist = options.playlistName; // not reliable — used for debug only

      tr.setAttribute('draggable', 'true');

      tr.innerHTML = `
          <img class="cover" src="${t.cover || 'https://via.placeholder.com/100'}" alt="album cover" loading="lazy">
          <div class="meta">
            <h3>${escapeHtml(t.title)}</h3>
            <p>${escapeHtml(t.artist)}</p>
          </div>
          <div style="display:flex; align-items:center;">
            <button class="play-btn" aria-label="Play">
              <i class="ri-play-fill"></i>
            </button>
            <button class="save-btn" aria-label="Save" title="Save to My Playlist"><i class="ri-bookmark-line"></i></button>
          </div>`;

      // drag events
      tr.addEventListener('dragstart', (ev) => {
        dragSrcEl = tr;
        tr.classList.add('dragging');
        const payload = {
          id: tr.dataset.trackId,
          title: tr.dataset.title,
          artist: tr.dataset.artist,
          cover: tr.dataset.cover,
          preview: tr.dataset.previewUrl,
          source: t.source || 'unknown'
        };
        ev.dataTransfer.setData('application/json', JSON.stringify(payload));
        ev.dataTransfer.effectAllowed = 'move';
        // optionally set a drag image
        try {
          const dragImg = tr.cloneNode(true);
          dragImg.style.position = 'absolute';
          dragImg.style.top = '-9999px';
          dragImg.style.left = '-9999px';
          document.body.appendChild(dragImg);
          ev.dataTransfer.setDragImage(dragImg, 20, 20);
          setTimeout(() => document.body.removeChild(dragImg), 0);
        } catch (e) { /* ignore */ }
      });

      tr.addEventListener('dragend', () => {
        tr.classList.remove('dragging');
        dragSrcEl = null;
        document.querySelectorAll('.tracks').forEach(el => el.classList.remove('drag-over'));
      });

      return tr;
    }

    // --- playlist card creation ---
    function createPlaylistCard(title, tracks, opts = {}) {
      const card = document.createElement('div');
      card.className = 'playlist-card';
      if (opts.isMy) card.id = 'my-playlist-card';
      card.dataset.playlistName = title;
      card.innerHTML = `<h2>${escapeHtml(title)}</h2><div class="tracks"></div>`;
      const tracksEl = card.querySelector('.tracks');

      // allow drop on tracks area
      tracksEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        tracksEl.classList.add('drag-over');
        e.dataTransfer.dropEffect = 'move';
      });
      tracksEl.addEventListener('dragleave', () => tracksEl.classList.remove('drag-over'));
      tracksEl.addEventListener('drop', (e) => {
        e.preventDefault();
        tracksEl.classList.remove('drag-over');

        const data = e.dataTransfer.getData('application/json');
        let payload = null;
        if (data) {
          try { payload = JSON.parse(data); } catch (err) { payload = null; }
        }

        // If dragging a DOM element from this page (dragSrcEl exists), we will move it.
        if (dragSrcEl && dragSrcEl.closest('.tracks')) {
          const sourceCard = dragSrcEl.closest('.playlist-card');
          const destCard = tracksEl.closest('.playlist-card');

          // If dropping into same container, move position to end (or between items could be improved)
          tracksEl.appendChild(dragSrcEl);

          // handle myPlaylist array updates
          if (destCard.id === 'my-playlist-card') {
            // add to myPlaylist if not present
            const toAdd = extractTrackDataFromElement(dragSrcEl);
            addToMyPlaylist(toAdd, /*scrollIntoView*/ false);
          }
          if (sourceCard && sourceCard.id === 'my-playlist-card' && destCard.id !== 'my-playlist-card') {
            // removed from My Playlist — remove from array
            const removedId = dragSrcEl.dataset.trackId;
            removeFromMyPlaylistById(removedId);
            // update save button state if present in source (we moved the element out)
          }
          updateSaveButtonsState();
          return;
        }

        // If payload exists (maybe external drag or newly constructed), create a new element and insert
        if (payload) {
          const newEl = createTrackElement(payload);
          tracksEl.appendChild(newEl);

          // If dropping into My Playlist, persist into myPlaylist data model
          const destCard = tracksEl.closest('.playlist-card');
          if (destCard && destCard.id === 'my-playlist-card') {
            addToMyPlaylist(payload, false);
            updateSaveButtonsState();
          }
        }
      });

      // fill tracks
      if (!tracks || tracks.length === 0) {
        tracksEl.innerHTML = `<p style="color:var(--muted);">No tracks found.</p>`;
        return card;
      }

      tracks.forEach(t => {
        const tr = createTrackElement(t, { playlistName: title });
        tracksEl.appendChild(tr);
      });

      return card;
    }

    // helper: build track DOM from dataset (for append in myPlaylist)
    function createTrackElementFromData(d) {
      return createTrackElement({
        id: d.id,
        title: d.title,
        artist: d.artist,
        cover: d.cover,
        preview: d.preview,
        source: d.source || 'unknown'
      });
    }

    function extractTrackDataFromElement(el) {
      return {
        id: el.dataset.trackId,
        title: el.dataset.title,
        artist: el.dataset.artist,
        cover: el.dataset.cover,
        preview: el.dataset.previewUrl,
        source: el.dataset.source || 'unknown'
      };
    }

    // --- Player logic ---
    function playTrack(trackData, button) {
      const { trackId, previewUrl, cover, title, artist } = trackData;
      const currentTrackIdStr = currentPlaying.trackId ? currentPlaying.trackId.toString() : null;

      if (currentPlaying.audio && currentTrackIdStr !== trackId) {
        currentPlaying.audio.pause();
        if (currentPlaying.button) {
          currentPlaying.button.innerHTML = '<i class="ri-play-fill"></i>';
          currentPlaying.button.classList.remove('playing');
        }
      }

      if (currentTrackIdStr === trackId) {
        if (player.paused) { player.play(); } else { player.pause(); }
        return;
      }

      player.src = previewUrl;
      player.play().catch(e => console.error("Autoplay was blocked", e));

      nowCover.src = cover;
      nowTitle.textContent = title;
      nowArtist.textContent = artist;
      playerFooter.style.display = 'block';

      currentPlaying = { audio: player, button: button, trackId: trackId };
      button.innerHTML = '<i class="ri-pause-fill"></i>';
      button.classList.add('playing');
    }

    function handlePlayButtonClick(ev) {
      const btn = ev.target.closest('.play-btn');
      if (!btn) return;
      const trackDiv = btn.closest('.track');
      const { trackId, previewUrl, cover, title, artist } = trackDiv.dataset;
      if (!previewUrl) {
        alert('Preview not available for this track.');
        return;
      }
      playTrack({ trackId, previewUrl, cover, title, artist }, btn);
    }

    player.onplay = () => {
      if (currentPlaying.button) {
        currentPlaying.button.innerHTML = '<i class="ri-pause-fill"></i>';
        currentPlaying.button.classList.add('playing');
      }
    };
    player.onpause = player.onended = () => {
      if (currentPlaying.button) {
        currentPlaying.button.innerHTML = '<i class="ri-play-fill"></i>';
        currentPlaying.button.classList.remove('playing');
      }
      if (player.ended) {
        currentPlaying = { audio: null, button: null, trackId: null };
      }
    };

    // --- Save (add to My Playlist) logic ---
    function addToMyPlaylist(trackObj, scrollIntoView = true) {
      if (!trackObj || !trackObj.id) return;
      if (myPlaylist.some(t => t.id.toString() === trackObj.id.toString())) return; // avoid duplicates

      // normalize object fields
      const normalized = {
        id: trackObj.id.toString(),
        title: trackObj.title || 'Unknown Title',
        artist: trackObj.artist || 'Unknown Artist',
        cover: trackObj.cover || '',
        preview: trackObj.preview || '',
        source: trackObj.source || 'unknown'
      };
      myPlaylist.push(normalized);

      // append to My Playlist DOM if exists
      const myCard = document.getElementById('my-playlist-card');
      if (myCard) {
        const tracksEl = myCard.querySelector('.tracks');
        const el = createTrackElementFromData(normalized);
        tracksEl.appendChild(el);
        if (scrollIntoView) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      updateSaveButtonsState();
    }

    function removeFromMyPlaylistById(id) {
      const idx = myPlaylist.findIndex(t => t.id.toString() === id.toString());
      if (idx === -1) return;
      myPlaylist.splice(idx, 1);
      // update DOM
      const myCard = document.getElementById('my-playlist-card');
      if (myCard) {
        const el = myCard.querySelector(`.track[data-track-id="${CSS.escape(id)}"]`);
        if (el) el.remove();
      }
      updateSaveButtonsState();
    }

    function updateSaveButtonsState() {
      // mark save buttons as saved if present in myPlaylist
      const savedIds = new Set(myPlaylist.map(t => t.id.toString()));
      document.querySelectorAll('.track').forEach(tr => {
        const saveBtn = tr.querySelector('.save-btn');
        if (!saveBtn) return;
        const id = tr.dataset.trackId ? tr.dataset.trackId.toString() : '';
        if (savedIds.has(id)) {
          saveBtn.classList.add('saved');
          saveBtn.title = 'Saved';
          saveBtn.innerHTML = '<i class="ri-bookmark-fill"></i>';
        } else {
          saveBtn.classList.remove('saved');
          saveBtn.title = 'Save to My Playlist';
          saveBtn.innerHTML = '<i class="ri-bookmark-line"></i>';
        }
      });
    }

    // --- App Initialization & Events ---

    // builds playlists grid: renders My Playlist then seeds asynchronously (shuffled)
    async function buildPlaylists() {
      playlistsEl.innerHTML = ''; // Clear view

      // 1. Render static My Playlist first
      const myPlaylistCard = createPlaylistCard('My Playlist', myPlaylist, { isMy: true });
      playlistsEl.appendChild(myPlaylistCard);

      // 2. Loop through API-based playlists, show placeholder then replace with fetched (shuffled)
      for (const [plName, artists] of Object.entries(seeds)) {
        const placeholder = (function (title) {
          const card = document.createElement('div');
          card.className = 'playlist-card';
          card.innerHTML = `<h2>${escapeHtml(title)}</h2><div class="tracks" style="justify-content:center; align-items:center; min-height:150px;">
            <p style="color:var(--muted);">Loading tracks...</p>
          </div>`;
          playlistsEl.appendChild(card);
          return card;
        })(plName);

        (async () => {
          const promises = artists.map(a => fetchItunesFor(a, 25));
          const results = (await Promise.all(promises)).flat();

          const unique = [];
          const seen = new Set();
          for (const r of results) {
            if (!r.preview || !r.id || seen.has(r.id)) continue;
            seen.add(r.id);
            unique.push(r);
          }

          // SHUFFLE here so songs render mixed and not album-by-album or artist-by-artist
          shuffle(unique);

          const topTracks = unique.slice(0, 20);

          const finalCard = createPlaylistCard(plName, topTracks);
          placeholder.replaceWith(finalCard);
          updateSaveButtonsState();
        })();
      }

      updateSaveButtonsState();
    }

    async function handleSearch() {
      const q = searchBox.value.trim();
      if (!q) return;
      playlistsEl.innerHTML = `<h2 style="font-weight:500;">Searching...</h2>`;
      const results = await fetchItunesFor(q, 50); // Increase search results limit
      playlistsEl.innerHTML = '';
      const card = createPlaylistCard(`Search results for "${escapeHtml(q)}"`, results);
      playlistsEl.appendChild(card);
      updateSaveButtonsState();
    }

    // Delegated click handling (play + save)
    playlistsEl.addEventListener('click', (ev) => {
      // Play button
      if (ev.target.closest('.play-btn')) {
        handlePlayButtonClick(ev);
        return;
      }

      // Save button
      const saveBtn = ev.target.closest('.save-btn');
      if (saveBtn) {
        const trackDiv = saveBtn.closest('.track');
        const trackData = extractTrackDataFromElement(trackDiv);
        addToMyPlaylist(trackData, true);
        updateSaveButtonsState();
      }
    });

    // keyboard search
    searchBox.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleSearch();
    });
    homeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      searchBox.value = '';
      buildPlaylists();
    });

    // ensure updateSaveButtonsState also when playlists change (drag/drop, etc.)
    playlistsEl.addEventListener('drop', () => setTimeout(updateSaveButtonsState, 50));

    // Initial build
    buildPlaylists();
  </script>
</body>

</html>